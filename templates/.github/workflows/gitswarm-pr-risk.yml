# GitSwarm PR Risk Assessment â€” GitHub Actions Workflow
#
# Triggered when the gitswarm app dispatches a pr-risk-gate event.
# Analyzes changed files to assess merge risk and optionally auto-approves
# low-risk changes to safe paths (docs, tests, etc.).
#
# Install: Copy to .github/workflows/ in your repo.

name: "GitSwarm: PR Risk Assessment"

on:
  repository_dispatch:
    types: [gitswarm.plugin.pr-risk-gate]

permissions:
  pull-requests: write
  contents: read

jobs:
  assess:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract event data
        id: event
        run: |
          echo "pr_number=${{ github.event.client_payload.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          echo "execution_id=${{ github.event.client_payload.gitswarm.execution_id }}" >> "$GITHUB_OUTPUT"

      - name: Assess risk
        id: risk
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.event.outputs.pr_number }}"

          # Get changed files
          FILES=$(gh pr diff "$PR_NUM" --name-only 2>/dev/null || echo "")
          FILE_COUNT=$(echo "$FILES" | grep -c . || echo "0")

          # Get additions/deletions
          STATS=$(gh pr view "$PR_NUM" --json additions,deletions 2>/dev/null || echo '{"additions":0,"deletions":0}')
          ADDITIONS=$(echo "$STATS" | jq '.additions // 0')
          DELETIONS=$(echo "$STATS" | jq '.deletions // 0')
          TOTAL_LINES=$((ADDITIONS + DELETIONS))

          # Risk assessment
          RISK="low"
          REASONS=""

          # Check for sensitive paths
          SENSITIVE_PATHS=".github/workflows/ .gitswarm/ scripts/ Dockerfile docker-compose"
          for path in $SENSITIVE_PATHS; do
            if echo "$FILES" | grep -q "$path"; then
              RISK="high"
              REASONS="${REASONS}- Modifies sensitive path: \`${path}\`\n"
            fi
          done

          # Check size
          if [ "$FILE_COUNT" -gt 15 ] || [ "$TOTAL_LINES" -gt 500 ]; then
            if [ "$RISK" != "high" ]; then RISK="medium"; fi
            REASONS="${REASONS}- Large change: ${FILE_COUNT} files, ${TOTAL_LINES} lines\n"
          fi

          # Check if all changes are in safe paths
          SAFE=true
          SAFE_PATHS="docs/ tests/ test/ *.md README CHANGELOG LICENSE"
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            IS_SAFE=false
            for safe in $SAFE_PATHS; do
              case "$file" in
                $safe*) IS_SAFE=true; break ;;
              esac
            done
            if [ "$IS_SAFE" = false ]; then
              SAFE=false
              break
            fi
          done <<< "$FILES"

          if [ "$SAFE" = true ] && [ "$RISK" = "low" ]; then
            REASONS="${REASONS}- All changes in safe paths (docs/tests)\n"
          fi

          echo "risk=$RISK" >> "$GITHUB_OUTPUT"
          echo "file_count=$FILE_COUNT" >> "$GITHUB_OUTPUT"
          echo "total_lines=$TOTAL_LINES" >> "$GITHUB_OUTPUT"
          echo "all_safe_paths=$SAFE" >> "$GITHUB_OUTPUT"
          {
            echo "reasons<<REOF"
            echo -e "$REASONS"
            echo "REOF"
          } >> "$GITHUB_OUTPUT"

      - name: Apply risk label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.event.outputs.pr_number }}"
          RISK="${{ steps.risk.outputs.risk }}"

          # Remove existing risk labels
          for label in low-risk medium-risk high-risk; do
            gh pr edit "$PR_NUM" --remove-label "$label" 2>/dev/null || true
          done

          # Add new risk label
          gh pr edit "$PR_NUM" --add-label "${RISK}-risk" 2>/dev/null || true

      - name: Post risk summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ steps.event.outputs.pr_number }}"
          RISK="${{ steps.risk.outputs.risk }}"
          FILES="${{ steps.risk.outputs.file_count }}"
          LINES="${{ steps.risk.outputs.total_lines }}"
          REASONS="${{ steps.risk.outputs.reasons }}"

          ICON="ðŸŸ¢"
          if [ "$RISK" = "medium" ]; then ICON="ðŸŸ¡"; fi
          if [ "$RISK" = "high" ]; then ICON="ðŸ”´"; fi

          COMMENT="### ${ICON} GitSwarm Risk Assessment: **${RISK}**

          | Metric | Value |
          |--------|-------|
          | Files changed | ${FILES} |
          | Lines changed | ${LINES} |

          ${REASONS}

          ---
          *Assessed by [GitSwarm](https://gitswarm.dev) plugin \`pr-risk-gate\`*"

          gh pr comment "$PR_NUM" --body "$COMMENT"

      - name: Report result to GitSwarm
        if: always()
        env:
          GITSWARM_API_KEY: ${{ secrets.GITSWARM_API_KEY }}
          GITSWARM_API_URL: ${{ secrets.GITSWARM_API_URL }}
        run: |
          EXEC_ID="${{ steps.event.outputs.execution_id }}"
          STATUS="${{ job.status == 'success' && 'completed' || 'failed' }}"

          if [ -n "$GITSWARM_API_URL" ] && [ -n "$GITSWARM_API_KEY" ] && [ -n "$EXEC_ID" ]; then
            curl -s -X POST \
              "${GITSWARM_API_URL}/plugins/executions/${EXEC_ID}/report" \
              -H "Authorization: Bearer ${GITSWARM_API_KEY}" \
              -H "Content-Type: application/json" \
              -d "{\"status\": \"${STATUS}\", \"actions_taken\": [{\"action\": \"risk_assessment\", \"risk\": \"${{ steps.risk.outputs.risk }}\"}]}" \
              || true
          fi
